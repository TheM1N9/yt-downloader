// Server-only caption utilities (uses ytdl-core)
import ytdl from "@distube/ytdl-core"
import type { CaptionTrack } from "./caption"

export async function getCaptionTracks(videoId: string): Promise<CaptionTrack[]> {
  const info = await ytdl.getInfo(`https://www.youtube.com/watch?v=${videoId}`)
  const captions = info.player_response?.captions

  if (!captions?.playerCaptionsTracklistRenderer?.captionTracks) {
    return []
  }

  return captions.playerCaptionsTracklistRenderer.captionTracks.map((track: {
    languageCode: string
    name: { simpleText?: string; runs?: { text: string }[] }
    kind?: string
    baseUrl: string
  }) => ({
    languageCode: track.languageCode,
    languageName: track.name?.simpleText || track.name?.runs?.[0]?.text || track.languageCode,
    isAutoGenerated: track.kind === "asr",
    baseUrl: track.baseUrl,
  }))
}

export async function fetchCaptionXml(baseUrl: string): Promise<string> {
  const response = await fetch(baseUrl)
  if (!response.ok) {
    throw new Error("Failed to fetch captions")
  }
  return response.text()
}
